(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{"./assets/const/API.ts":function(e,t,a){"use strict";const s="/"+a("./common/SYSTEM.js").urlVersion.value+"/api",i={tableQuery:{url:"/table/list",description:"查询mysql表数据，该接口将会失效"},queryTable:{url:"/table/query",description:"查询mysql表数据，优先使用这个",type:"all"},queryOne:{url:"/table/query-one",description:"跟queryTable差不多，但只获取一个"},removeTableRecord:{url:"/table/remove",description:"删除指定fields的数据，可以删除一个或多个"},getByKeyName:{url:"/table/getByKeyName",description:"通过keyName字段去查询表中数据"},tableDistinctQuery:{url:"/table/distinct",description:"滤重方式查询mysql的某个字段"},getOneFromTable:{url:"/table/one",description:"通过主键ID的值，从mysql表中获取单条数据"},updateTableRow:{url:"/table/upsert",description:"更新或新增mysql表中的某条数据，仅支持POST方式"},duplicateRow:{url:"/table/duplicateOne",description:"复制一条纪录到同一个表"},multiTableUpsert:{url:"/table/multi-upsert",description:"可以单次提交多个mysql表的更新或新增"},multiTableSave:{url:"/table/multi-save",description:"可以提交多个表的更新操作，包括新增、删除、更新"},reUploadImage:{url:"/common/re-upload",description:"转发上传图片到java服务器"},serverRequest:{url:"/common/redirect",description:"由于权限和跨域的原因，浏览器不能直接请求某个API，需要用这个API来帮忙请求。"},deleteOneFromTable:{url:"/table/deleteOne",description:"从 mysql 表中删除某条数据"},saveDistribution:{url:"/distribution/save",description:"保存分发运营配置"},pushUpDistribution:{url:"/distribution/pushUp",description:"置顶某条内容"},blockDistribution:{url:"/distribution/block",description:"屏蔽某条内容"},getDistributionStyle:{url:"/distribution/getStyle",description:"获取某条位置的样式"},saveDistributionStyle:{url:"/distribution/saveStyle",description:"保存某条位置的样式"},freshDistributionCache:{url:"/distribution/freshCache",description:"刷新缓存"},crawlUrl:{url:"/crawl/getContent",description:"抓取某个页面的内容，返回json数据",type:"POST"},exportData:{url:"/table/export",description:"下载SQL数据",type:"GET"},importData:{url:"/table/import",description:"上传SQL数据",type:"POST"},saveImage:{url:"/crawl/save-image",description:"保存图片到魅族服务器",type:"POST"}};Object.keys(i).forEach(e=>i[e].url=s+i[e].url),t.a=i},"./assets/lib/Component.ts":function(e,t,a){"use strict";a.d(t,"a",function(){return l});var s=a("./node_modules/react/index.js"),i=a("./assets/lib/handy.ts");class l extends s.Component{constructor(e){super(e),i.a.setTitle(e)}}},"./assets/page/CPAPIManage.tsx":function(e,t,a){"use strict";a.r(t);var s=a("./node_modules/react/index.js"),i=a("./assets/lib/Component.ts"),l=a("./node_modules/react-redux/es/index.js"),n=a("./assets/lib/ajax.ts"),r=a("./assets/const/API.ts"),o=a("./assets/lib/handy.ts"),d=a("./assets/const/SITE_INFO.ts"),u=a("./node_modules/antd/es/steps/index.js"),c=a("./node_modules/antd/es/form/index.js"),m=a("./node_modules/antd/es/select/index.js"),p=a("./node_modules/antd/es/input/index.js"),h=a("./node_modules/antd/es/message/index.js"),g=a("./node_modules/antd/es/modal/index.js"),y=a("./node_modules/antd/es/switch/index.js"),v=a("./node_modules/antd/es/col/index.js"),b=a("./node_modules/antd/es/button/index.js"),f=a("./node_modules/antd/es/icon/index.js"),E=a("./node_modules/antd/es/divider/index.js"),k=a("./node_modules/antd/es/auto-complete/index.js"),S=a("./node_modules/antd/es/tooltip/index.js"),M=a("./node_modules/antd/es/spin/index.js"),N=function(e,t,a,s){return new(a||(a=Promise))(function(i,l){function n(e){try{o(s.next(e))}catch(e){l(e)}}function r(e){try{o(s.throw(e))}catch(e){l(e)}}function o(e){e.done?i(e.value):new a(function(t){t(e.value)}).then(n,r)}o((s=s.apply(e,t||[])).next())})};const x=a("./node_modules/urijs/src/URI.js"),C=a("./node_modules/flat/index.js"),I=a("./node_modules/jsoneditor/index.js"),L=u.a.Step,R=c.a.Item,V=m.a.Option,O=p.a.TextArea,w=p.a.Group,j=[{name:"MD5",value:1},{name:"SHA1",value:2},{name:"SHA256",value:3}];const P=Object(l.b)()(class extends i.a{constructor(e){super(e),this.signReg=/^signSchema\./,this.nextStep=(()=>N(this,void 0,void 0,function*(){if(1===this.state.current){const e=yield this.getGrabApiResult(),t=C(e),a=Object.keys(t);this.setState({cpSourceMap:a.map(e=>({key:"$."+e,value:t[e]}))}),yield this.getResultModelList(),this.getResultMapDetail(),this.getErrorCode()}this.setState({current:this.state.current+1})})),this.previousStep=(()=>{this.setState({current:this.state.current-1})}),this.upsertSignSchema=(()=>N(this,void 0,void 0,function*(){const{field:e,fields:t}=this.getField("signId"),a=e.value,s={},i=t.filter(e=>"sign"===e.category);for(const e of i)if(this.signReg.test(e.keyName)){const t=e.keyName.replace("signSchema.","");let a;a="list"===e.type?e.value.filter(e=>!1===["",void 0,null].includes(e)):e.value,s[t]=a}const l=!!a;!1===l&&(delete s.id,s.cpId=this.cpId);const o=d.a.domain+"/service/biz/grab/sign/update",u=d.a.domain+"/service/biz/grab/sign/add",c=new x(l?o:u),m=new x(r.a.serverRequest.url);m.setQuery("url",c.toString()),this.startLoading();const p=yield n.a.post(m.toString(),s);this.stopLoading(),200===p.code?(h.a.success("保存签名成功"),this.freshSignList(),this.freshSignSchema(a)):h.a.error("保存签名失败："+p.message)})),this.getResultMapDetail=(()=>N(this,void 0,void 0,function*(){const e=new x(d.a.domain+"/service/biz/grab/result/detail");e.setQuery("grabId",this.grabId),this.startLoading();const t=yield n.a.get(r.a.serverRequest.url,{url:e.toString()});if(this.stopLoading(),200===t.code){if(t.value){let e=[];if(t.value.fixedValues){const a=JSON.parse(t.value.fixedValues);a.fixedValueMap&&(e=Object.keys(a.fixedValueMap).map(e=>({key:e,value:a.fixedValueMap[e]})))}let a=[];t.value.mappings&&(a=JSON.parse(t.value.mappings).map(e=>({keyName:e.keyName,valNames:Array.isArray(e.valNames)?e.valNames.join(","):e.valNames?e.valNames:"",expression:e.expression})));let s=t.value.mappingValues,i=[];if(s){const e=s.match(/"mappingMap"\s*:\s*({[^}]*})/g);e&&e.length&&(e.forEach(e=>{const t=e.replace(/"mappingMap"\s*:\s*/,"").replace(/\s*/g,"").replace(/^\{/,"").replace(/\}$/,"").split(",").map(e=>{if(!e)return;const t=e.split(/:(.+)/);return{source:t[0].replace(/"/g,""),target:t[1].replace(/"/g,"")}}).filter(e=>!!e);s=s.replace(e,'"mappingMap":'+JSON.stringify(t))}),i=JSON.parse(s))}const l=t.value.modeId,{resultModel:n,resultModelList:r}=this.getResultModelAndList(l);if(!n)return void h.a.error("找不到相应的转换模型");n.mappings=a,n.mappingValues=i,n.fixedValueMap=e,n.grabId=this.grabId,n.resultId=t.value.id,this.setState({resultModelList:r,modelId:l}),this.getResultModel(t.value.modeId)}}else h.a.error("获取来源结果转换配置失败："+t.message)})),this.getResultModelList=(()=>N(this,void 0,void 0,function*(){if(this.state.resultModelList.length)return void console.log("model list is exist, dont retrieve again.");const e=new x(d.a.domain+"/service/biz/grab/result/model");this.startLoading();const t=yield n.a.get(r.a.serverRequest.url,{url:e.toString()});this.stopLoading(),200===t.code?this.setState({resultModelList:t.value}):h.a.error("获取转换模型列表失败："+t.message)})),this.getResultModel=(e=>N(this,void 0,void 0,function*(){const{resultModel:t,resultModelList:a}=this.getResultModelAndList(e);if(t.model&&t.model.length)return void console.log("this model has been retrieved, dont fetch again.");const s=new x(d.a.domain+"/service/biz/grab/result/getModel");s.setQuery("modelId",e),this.startLoading();const i=yield n.a.get(r.a.serverRequest.url,{url:s.toString()});this.stopLoading(),200===i.code?(t.model=i.value,this.setState({resultModelList:a})):h.a.error("获取转换模型失败："+i.message)})),this.getGrabApiResult=(()=>N(this,void 0,void 0,function*(){const e=new x("http://om.iflow.meizu.com/service/biz/grab/test"),t=new x(r.a.serverRequest.url);t.setQuery("url",e.toString());const a=this.makeSignSchemeFromFields(),s=this.makeRequestSchemaFromFields();this.startLoading();const i=yield n.a.post(t.toString(),{signSchemaString:a,grabParamString:s,grabSite:{}});return this.stopLoading(),200!==i.code&&h.a.error("获取测试数据失败: "+i.message),JSON.parse(i.value)})),this.checkGrabApi=(()=>N(this,void 0,void 0,function*(){const e=yield this.getGrabApiResult();e?this.viewJsonResult(e):h.a.error("没有返回数据")})),this.resultMapAdd=(()=>{const{resultModel:e,resultModelList:t}=this.getResultModelAndList();e.mappings||(e.mappings=[]),e.mappings.push({keyName:"",keyValue:""}),this.setState({resultModelList:t})}),this.resultItemChange=((e,t,a)=>{const s=a&&a.target?a.target.value:a,{resultModel:i,resultModelList:l}=this.getResultModelAndList();i.mappings[e][t]=s,this.setState({resultModelList:l})}),this.resultItemDelete=(e=>{const{resultModel:t,resultModelList:a}=this.getResultModelAndList();t.mappings.splice(e,1),this.setState({resultModelList:a})}),this.toggleResultExpressionModal=((e,t="")=>{const{resultModel:a,resultModelList:s}=this.getResultModelAndList(),i=a.mappings[e];let l="",n=!1;null!==e&&(l=i.expression,n=!0),"cancel"===t&&(i.expression=this.state.expressionCache,n=!1,e=null),"save"===t&&(n=!1),this.setState({isResultExpressionOpen:n,resultMapEditingIndex:e,expressionCache:l,resultModelList:s})}),this.resultExpressChange=(e=>{const{resultModel:t,resultModelList:a}=this.getResultModelAndList();t.mappings[this.state.resultMapEditingIndex].expression=e.target.value,this.setState({resultModelList:a})}),this.checkResultModel=(()=>N(this,void 0,void 0,function*(){const e=this.makeResultModelPayload(),t=new x(d.a.domain+"/service/biz/grab/result/test"),a=new x(r.a.serverRequest.url);a.setQuery("url",t.toString()),this.startLoading();const s=yield n.a.post(a.toString(),e);this.stopLoading(),200===s.code?this.viewJsonResult(s.value):h.a.error("获取验证信息失败："+s.message)})),this.invokeSaveGrab=(()=>N(this,void 0,void 0,function*(){const e=this.makeRequestSchemaFromFields(),t=new x(d.a.domain+"/service/biz/grab/update"),a=new x(r.a.serverRequest.url);a.setQuery("url",t.toString()),this.startLoading();const s=yield n.a.post(a.toString(),e);return this.stopLoading(),s})),this.saveGrab=(()=>N(this,void 0,void 0,function*(){const e=yield this.invokeSaveGrab();200===e.code?e.value?(!0===e.value||(this.grabId=+e.value),h.a.success("保存成功"),this.getDetail()):h.a.error("没返回保存grab的id."):h.a.error("保存访问配置失败："+e.message)})),this.saveGrabResult=(()=>N(this,void 0,void 0,function*(){const e=yield this.invokeSaveGrab();if(200!==e.code)return void h.a.error("保存访问配置失败："+e.message);this.getDetail(),this.getResultMapDetail();const t=this.makeGrabResultParam(),a=new x(r.a.serverRequest.url);a.setQuery("url",d.a.domain+"/service/biz/grab/result/update"),this.startLoading();const s=yield n.a.post(a.toString(),t);this.stopLoading(),200===s.code?(h.a.success("保存成功"),this.getResultMapDetail()):h.a.error("保存转换配置失败："+s.message)})),this.cancel=(()=>{this.isEdited?g.a.confirm({title:"提示",content:"编辑的内容将会丢失，确定？",onOk(){window.history.back()}}):window.history.back()}),this.closeJsonViewer=(()=>{this.setState({isJsonViewerOpen:!1})}),this.closeJsonEditor=(()=>{this.setState({isJsonEditorOpen:!1})}),this.saveJson=(()=>{this.multiValueChange(this.jsonEditorKeyName,this.jsonEditorIndex,"value",JSON.stringify(this.jsonEditor.get())),this.closeJsonEditor()}),this.proxyParamChange=((e,t)=>{const a=this.clone(this.state.proxyParam);a[e]=t.target.value,this.setState({proxyParam:a})}),this.proxyParamDrop=(e=>{const t=this.clone(this.state.proxyParam);t[e]=this.state.dragging.key,this.setState({proxyParam:t})}),this.dragItem=((e,t)=>{this.setState({dragging:Object.assign({},e,{_from:t})})}),this.addProxyItem=(()=>{const e=this.clone(this.state.proxyMap);e.push({rule:"",name:"",valueType:null,objectType:null,map:[]}),this.setState({proxyMap:e})}),this.deleteProxyItem=(e=>{const t=this.clone(this.state.proxyMap);t.splice(e,1),this.setState({proxyMap:t})}),this.proxyItemChange=((e,t,a)=>{const s=a&&a.target?a.target.value:a,i=this.clone(this.state.proxyMap);i[e][t]=s,this.setState({proxyMap:i})}),this.proxyItemDrop=(e=>{const t=this.clone(this.state.proxyMap);t[e].rule=this.state.dragging.key,this.setState({proxyMap:t})}),this.preventDragOver=(e=>{e.preventDefault()}),this.toggleMapEditor=(e=>{if(!e)return void h.a.error("请先选择目标参数");if("_ok"===e)return void this.setState({isMapEditorOpen:!1});const{resultModel:t,resultModelList:a}=this.getResultModelAndList();t.mappingValues||(t.mappingValues=[]);const s=t.mappingValues;if("_cancel"===e){const e=this.state.editingResultDataMap.keyName,t=s.findIndex(t=>t.keyName===e);return s.splice(t,1,this.state.editingResultDataMap),void this.setState({resultModelList:a,isMapEditorOpen:!1})}e&&(s.find(t=>t.keyName===e)||s.push({defaultValue:"",keyName:e,mappingMap:[],paramMappingSelectEnum:""}));const i=s.find(t=>t.keyName===e);this.setState({editingResultDataMap:i,resultModelList:a,isMapEditorOpen:!this.state.isMapEditorOpen,editingMapKeyName:e})}),this.addMapItem=(()=>{const{resultModel:e,resultModelList:t}=this.getResultModelAndList();e.mappingValues.push({keyName:"",defaultValue:"",paramMappingSelectEnum:null,mappingMap:[]}),this.setState({resultModelList:t})}),this.addMappingMap=(()=>{const{resultModel:e,resultModelList:t}=this.getResultModelAndList();e.mappingValues.find(e=>e.keyName===this.state.editingMapKeyName).mappingMap.push({source:"",target:""}),this.setState({resultModelList:t})}),this.mapItemChange=((e,t,a)=>{const{resultModel:s,resultModelList:i}=this.getResultModelAndList(),l=s.mappingValues,n=a&&a.target?a.target.value:a,r=l.find(e=>e.keyName===this.state.editingMapKeyName);null===t?r[e]=n:r.mappingMap[t][e]=n,this.setState({resultModelList:i})}),this.modelIdChange=(e=>{this.getResultModel(e),this.setState({modelId:e})}),this.addFixedValueMap=(()=>{const{resultModel:e,resultModelList:t}=this.getResultModelAndList();!1===Array.isArray(e.fixedValueMap)&&(console.log("fixedValueMap not a array, set it to array"),e.fixedValueMap=[]),e.fixedValueMap.push({key:"",value:""}),this.setState({resultModelList:t})}),this.deleteFixedValueMap=(e=>{const{resultModel:t,resultModelList:a}=this.getResultModelAndList();t.fixedValueMap.splice(e,1),this.setState({resultModelList:a})}),this.changeFixedValueMap=((e,t,a)=>{const{resultModel:s,resultModelList:i}=this.getResultModelAndList();s.fixedValueMap[e][t]=a.target.value,this.setState({resultModelList:i})});const t=new x;this.query=t.query(!0),this.grabId=this.query.id||0,this.cpId=this.query.cpId,this.isEditing=!!this.grabId,this.isEdited=!1,this.isSignEdited=!1,this.state={loading:0,current:0,cpSourceMap:[],proxyMap:[],expressionCache:"",modelId:null,resultModelList:[],proxyParam:{attributes:"",baseRule:""},isMapEditorOpen:!1,isResultExpressionOpen:!1,isJsonEditorOpen:!1,isJsonViewerOpen:!1,editingMapKeyName:0,resultMapEditingIndex:null,editingResultDataMap:{},dragging:{},errorCode:[],fields:[{label:"签名",keyName:"signSchema.id",category:"sign",options:[],type:"select",emptyName:"新建"},{label:"CP ID",keyName:"signSchema.cpId",category:"sign",isHide:!0},{label:"签名名称",keyName:"signSchema.remark",category:"sign"},{label:"签名类型",keyName:"signSchema.signTypeEnum",category:"sign",type:"select",options:j},{label:"字符串添加位置",keyName:"signSchema.positionEnum",category:"sign",type:"select",options:[{name:"HEAD",value:1},{name:"URL",value:2},{name:"ENTITY",value:3}]},{label:"参数排序方式",keyName:"signSchema.signParamOrderEnum",category:"sign",type:"select",options:[{name:"指定顺序",value:1},{name:"按参数key正序",value:2},{name:"按参数key逆序",value:3},{name:"按value正序",value:4},{name:"按value逆序",value:5}]},{label:"签名参数名称",keyName:"signSchema.signParamName",category:"sign"},{label:"待签名参数",keyName:"signSchema.paramNames",category:"sign",type:"list",value:[]},{label:"单个参数格式",keyName:"signSchema.singleParamFormat",category:"sign"},{label:"开始字符",keyName:"signSchema.beginCharacter",category:"sign",placeholder:"不参与排序的签名key"},{label:"结束字符",keyName:"signSchema.endCharacter",category:"sign",placeholder:"不参与排序的签名key"},{label:"参数拼接字符",keyName:"signSchema.spliceCharacter",category:"sign",placeholder:"参与排序的参数"},{label:"参与排序的签名key",keyName:"signSchema.signKeyMap",category:"sign"},{label:"保留最后的拼接字符",keyName:"signSchema.hasLastSplice",category:"sign",type:"switch"},{label:"签名",keyName:"signId",category:"request",type:"select",options:[]},{label:"名称",keyName:"name",category:"request",required:!0},{label:"URL",keyName:"url",category:"request",required:!0},{label:"访问方式",keyName:"methodType",category:"request",type:"select",required:!0,options:[{name:"GET",value:1},{name:"POST(Json)",value:2},{name:"POST(Map)",value:3}]},{label:"token位置",keyName:"positionEnum",category:"request",type:"select",options:[{name:"head",value:"HEAD"},{name:"url",value:"URL"},{name:"entity",value:"ENTITY"}]},{label:"token名称",keyName:"tokenName",category:"request"},{label:"token获取方式",keyName:"tokenGrabId",category:"request",type:"select",options:[]},{label:"用户唯一标识",placeholder:"标识token使用",category:"request",keyName:"userTokenRule"},{label:"返回数据格式",keyName:"extractElement.type",category:"request",type:"select",options:[{name:"HTML",value:"HTML"},{name:"JSON",value:"JSON"},{name:"JSONP",value:"JSONP"}]},{label:"JSONP回调名",keyName:"extractElement.jsonpMethod",category:"request",isShow:{keyName:"extractElement.type",value:"JSONP"}},{label:"head参数",keyName:"heads",category:"request",type:"multi-value",value:[{key:"",value:""}],combine:{key:"headName",value:"headValue"}},{label:"参数map结构",keyName:"paramSchema.paramMap",category:"request",type:"multi-value",value:[{key:"",value:""}]},{label:"返回码表达式",keyName:"extractElement.grabResultDataStatus.codeSchema.expression",category:"error-handle",source:"grab-detail",noGrid:!0},{label:"返回码名称",keyName:"extractElement.grabResultDataStatus.codeSchema.name",category:"error-handle",source:"grab-detail",noGrid:!0,defaultValue:"code"},{label:"返回码类型",keyName:"extractElement.grabResultDataStatus.codeSchema.objectType",category:"error-handle",type:"select",source:"grab-detail",options:[{name:"对象",value:"OBJECT"},{name:"列表",value:"LIST"}],noGrid:!0},{label:"成功码列表",keyName:"extractElement.grabResultDataStatus.success",category:"error-handle",placeholder:"请使用英文逗号分隔",type:"string-list",source:"grab-detail",noGrid:!0},{label:"错误码映射",keyName:"extractElement.grabResultDataStatus.errorCodeMap",category:"error-handle",type:"key-value",source:"grab-detail",noGrid:!0,valueConfig:{type:"select",options:"errorCode",placeholder:"值"},keyConfig:{type:"input",placeholder:"键"}}]}}applySignSchema(e){const t=this.clone(this.state.fields);for(const a of t)if("sign"===a.category&&this.signReg.test(a.keyName)){const t=e[a.keyName.replace("signSchema.","")];"list"===a.type?a.value="string"==typeof t?JSON.parse(t):t:a.value=t}this.setState({fields:t})}freshSignSchema(e){return N(this,void 0,void 0,function*(){if(!e)return void this.applySignSchema({id:e,beginCharacter:"",endCharacter:"",hasLastSplice:0,paramNames:[""],positionEnum:null,remark:"",signKeyMap:null,signParamName:"",signParamOrderEnum:null,signTypeEnum:null,singleParamFormat:"",spliceCharacter:""});this.startLoading();const t=new x("http://om.iflow.meizu.com/service/biz/grab/sign/detail");t.setQuery("signId",e);const a=yield n.a.get(r.a.serverRequest.url,{url:t.toString()});if(this.stopLoading(),200!==a.code)return void h.a.error("获取签名信息失败："+a.message);const s=a.value;this.applySignSchema(s)})}switchSignSchema(e){const t=()=>{const{field:t,fields:a}=this.getField("signId");t.value=e,this.setState({fields:a},this.freshSignSchema.bind(this,e)),this.isSignEdited=!1};!1!==this.isSignEdited?g.a.confirm({title:"提示",onOk:t,content:"当前配置将会丢失，确定？"}):t()}getDetail(){return N(this,void 0,void 0,function*(){if(!this.grabId)return void console.log("new grab api.");const e=new x(d.a.domain+"/service/biz/grab/detail");e.setQuery("grabId",this.grabId);const t=e.toString();this.startLoading();const a=yield n.a.get(r.a.serverRequest.url,{url:t});if(this.stopLoading(),200!==a.code)return void h.a.error("获取接口配置详情失败："+a.message);let s=this.clone(this.state.fields);const i=a.value;if(i.paramSchema&&(i.paramSchema=JSON.parse(i.paramSchema)),i.grabExtractElement&&(i.grabExtractElement=JSON.parse(i.grabExtractElement)),i.signSchema&&(i.signSchema.signParamOrderEnum=i.signSchema.signParamOrderEnumInt),s=s.map(e=>{const t=e.keyName,s=o.a.isValuePath(t);let l=a.value[t];if(s&&(l=o.a.getValueByPath(i,e.keyName)),["",null,void 0].includes(l)&&void 0!==e.defaultValue&&(l=e.defaultValue),"string-list"===e.type&&(l=Array.isArray(l)?l.join(","):""),"select"===e.type&&l&&!1===e.options.some(e=>e.value===l)){const t=e.options.find(e=>e.name===l);t&&(l=t.value)}return["multi-value","key-value"].includes(e.type)?("string"==typeof l&&(l=JSON.parse(l)),!l||Array.isArray(l)&&0===l.length?e.value=[{key:"",value:""}]:Array.isArray(l)?e.combine?e.value=l.map(t=>({key:t[e.combine.key],value:t[e.combine.value]})):e.value=l:"object"==typeof l&&(e.value=Object.keys(l).map(e=>({key:e,value:l[e]})))):"list"===e.type?e.value=l||[""]:e.value=l,e}),i.originalParam){const e=this.clone(this.state.proxyParam);e.attributes=i.originalParam.attributes,e.baseRule=i.originalParam.baseRule;const t=i.originalParam.params.map(e=>({rule:e.rule,name:e.name,valueType:e.valueType,objectType:e.objectType}));this.setState({proxyParam:e,proxyMap:t})}this.setState({fields:s})})}getResultModelAndList(e){e||(e=this.state.modelId);const t=this.clone(this.state.resultModelList);return{resultModelList:t,resultModel:t.find(t=>t.id===e)}}componentDidMount(){return N(this,void 0,void 0,function*(){yield this.getDetail(),yield this.freshGrabList();const e=this.findField(this.state.fields,"signId");this.freshSignSchema(e.value),this.freshSignList()})}freshSignList(){return N(this,void 0,void 0,function*(){this.startLoading();const e=new x(d.a.domain+"/service/biz/grab/sign/list"),t=yield n.a.get(r.a.serverRequest.url,{url:e.toString()});if(this.stopLoading(),200!==t.code)return void h.a.error("获取签名列表失败："+t.message);const a=this.clone(this.state.fields),s=t.value.map(e=>({name:e.remark,value:e.id}));for(const e of a)["signId","signSchema.id"].includes(e.keyName)&&(e.options=s);this.setState({fields:a})})}freshGrabList(){return N(this,void 0,void 0,function*(){const e=new x(d.a.domain+"/service/biz/grab/list");e.setQuery("cpId",this.cpId),this.startLoading();const t=yield n.a.get(r.a.serverRequest.url,{url:e.toString()});if(this.stopLoading(),200!==t.code)return void h.a.error("获取当前CP的接口列表失败："+t.message);const{field:a,fields:s}=this.getField("tokenGrabId");a.options=t.value.map(e=>({name:e.name,value:e.id})),this.setState({fields:s})})}startLoading(){this.setState(e=>({loading:e.loading+1}))}stopLoading(){this.setState(e=>({loading:e.loading-1}))}clone(e){return JSON.parse(JSON.stringify(e))}getField(e){const t=this.clone(this.state.fields);return{fields:t,field:this.findField(t,e)}}findField(e,t){return e.find(e=>e.keyName===t)}addMultiValue(e){const{field:t,fields:a}=this.getField(e);t.value.push({key:void 0,value:void 0}),this.setState({fields:a})}deleteMultiValue(e,t){const{field:a,fields:s}=this.getField(e);a.value.splice(t,1),this.setState({fields:s})}multiValueChange(e,t,a,s){const i=s&&s.target?s.target.value:s,{field:l,fields:n}=this.getField(e);l.value[t][a]=i,this.setState({fields:n}),this.isEdited=!0}listValueChange(e,t,a){const s=a.target.value,{field:i,fields:l}=this.getField(e);i.value[t]=s,this.setState({fields:l})}addListValue(e){const{field:t,fields:a}=this.getField(e);t.value.push(""),this.setState({fields:a})}deleteListValue(e,t){const{field:a,fields:s}=this.getField(e);a.value.splice(t,1),this.setState({fields:s})}changeValue(e,t){const a=t&&t.target?t.target.value:t,s=this.clone(this.state.fields);this.findField(s,e).value=a,this.setState({fields:s}),this.isEdited=!0,this.signReg.test(e)&&(this.isSignEdited=!0)}makeSignSchemeFromFields(){const e={};for(const t of this.state.fields)if(this.signReg.test(t.keyName)){const a=t.keyName.replace(this.signReg,"");a&&(e[a]=t.value)}return e}makeRequestSchemaFromFields(){const e={extractElement:{},originalParam:{}};this.grabId&&(e.id=+this.grabId),e.cpId=+this.cpId;for(const t of this.state.fields){if(!1===["error-handle","request"].includes(t.category))continue;const a=this.getFieldValue(t);o.a.isValuePath(t.keyName)?o.a.applyObjByPath(e,t.keyName,a):e[t.keyName]=a}if(this.state.proxyParam){const t=this.state.proxyParam;e.originalParam.attributes=t.attributes,e.originalParam.baseRule=t.baseRule}return Array.isArray(this.state.proxyMap)&&(e.originalParam.params=this.state.proxyMap.map(e=>e)),e.extractElement.grabResultDataStatus.codeSchema.expression||delete e.extractElement.grabResultDataStatus,e}getFieldValue(e){if("string-list"===e.type)return"string"==typeof e.value?e.value.split(",").map(e=>e.trim()):[];if(["multi-value","key-value"].includes(e.type)){let t;const a=!!e.combine;return t=a?[]:{},e.value.forEach(s=>{s.key&&("string"==typeof s.value&&o.a.isJsonValue(s.value)&&(s.value=JSON.parse(s.value)),a?t.push({[e.combine.key]:s.key,[e.combine.value]:s.value}):t[s.key]=this.adjustValueType(s.value))}),t}return e.value}makeGrabResultParam(){const e=this.state.resultModelList.find(e=>e.id===this.state.modelId);if(!e)return void h.a.error("找不到转换模型");const t=this.clone(e);if(delete t.model,Array.isArray(t.mappingValues)&&t.mappingValues.length&&(t.mappingValues=t.mappingValues.map(e=>{if(Array.isArray(e.mappingMap)&&e.mappingMap.length){const t={};e.mappingMap.forEach(e=>{const a=this.adjustValueType(e.source),s=this.adjustValueType(e.target);t[a]=s}),e.mappingMap=t}else if(e.mappingMap={},!e.paramMappingSelectEnum&&!e.defaultValue)return null;return e}).filter(e=>!!e)),Array.isArray(t.fixedValueMap)&&t.fixedValueMap.length){const e={};t.fixedValueMap.forEach(t=>{e[t.key]=this.adjustValueType(t.value)}),t.fixedValues={fixedValueMap:e},delete t.fixedValueMap}return t.mappings=t.mappings.map(function(e){return"string"==typeof e.valNames&&e.valNames?e.valNames=e.valNames.split(","):["",null,void 0].includes(e.valNames)?e.valNames=[]:e.valNames=[e.valNames],e}),t.fixedValues=JSON.stringify(t.fixedValues),t.mappingValues=JSON.stringify(t.mappingValues),t.mappings=JSON.stringify(t.mappings),t.modeId=this.state.modelId,this.grabId&&(t.grabId=+this.grabId),t.resultId?(t.id=t.resultId,delete t.resultId):delete t.id,t}adjustValueType(e){if("string"!=typeof e)return e;if("null"===e)return null;if("true"===e)return!0;if("false"===e)return!1;if("undefined"!==e){if(""===e)return"";if(!1===/[^\d]/.test(e)){const t=+e;t<Number.MAX_SAFE_INTEGER&&(e=t)}return e}}makeResultModelPayload(){return{signSchemaString:this.makeSignSchemeFromFields(),grabParamString:this.makeRequestSchemaFromFields(),grabResultParamString:this.makeGrabResultParam(),grabSite:{}}}getErrorCode(){return N(this,void 0,void 0,function*(){const e=new x(d.a.domain+"/service/biz/grab/result/getErrorCode");this.startLoading();const t=yield n.a.get(r.a.serverRequest.url,{url:e.toString()});if(this.stopLoading(),200!==t.code)return void h.a.error("获取错误码列表错误："+t.message);const a=Array.isArray(t.value)?t.value.map(e=>({name:e.des,value:e.type})):[];this.setState({errorCode:a})})}openJsonEditor(e,t){let a=this.state.fields.find(t=>t.keyName===e).value[t].value;"string"==typeof a&&(a=JSON.parse(a)),this.setState({isJsonEditorOpen:!0},()=>{this.jsonEditorKeyName=e,this.jsonEditorIndex=t,setTimeout(()=>{if(void 0===this.jsonEditor){const e=document.getElementById("json-editor"),t={};this.jsonEditor=new I(e,t)}this.jsonEditor.set(a)},10)})}viewJsonResult(e){if(e){if("object"!=typeof e)try{e=JSON.parse(e)}catch(e){return void h.a.error("json-editor: 无法展示该变量")}this.setState({isJsonViewerOpen:!0},()=>{setTimeout(()=>{if(void 0===this.jsonViewer){const e=document.getElementById("json-viewer"),t={};this.jsonViewer=new I(e,t)}this.jsonViewer.set(e)},10)})}}makeFormItem(e){if(e.isShow){const t=e.isShow.keyName,a=e.isShow.value;if(this.findField(this.state.fields,t).value!==a)return""}else if(e.isHide)return"";const t={},a={};let i;if(e.placeholder&&(t.placeholder=e.placeholder),e.readonly&&(t.disabled=!0),t.onChange=this.changeValue.bind(this,e.keyName),t.value=e.value,"switch"===e.type)i=s.createElement(y.a,Object.assign({},t));else if("list"===e.type)i=e.value.map((t,a)=>s.createElement("div",{key:a},s.createElement(v.a,{span:20},s.createElement(R,null,s.createElement(p.a,{value:t,onChange:this.listValueChange.bind(this,e.keyName,a)}))),s.createElement(v.a,{span:3,offset:1},s.createElement(b.a.Group,null,s.createElement(b.a,{icon:"plus",onClick:this.addListValue.bind(this,e.keyName)}),1!==e.value.length&&s.createElement(b.a,{icon:"minus",onClick:this.deleteListValue.bind(this,e.keyName,a)})))));else if("multi-value"===e.type){const t={span:4},a={span:18};i=e.value.map((i,l)=>{const n=s.createElement(f.a,{type:"edit",onClick:this.openJsonEditor.bind(this,e.keyName,l,"value")});"string"!=typeof i.value&&(i.value=JSON.stringify(i.value));let r=o.a.isJsonValue(i.value);return s.createElement("div",{key:l},s.createElement(v.a,{span:10},s.createElement(R,{label:"参数",labelCol:t,wrapperCol:a},s.createElement(p.a,{value:i.key,onChange:this.multiValueChange.bind(this,e.keyName,l,"key")}))),s.createElement(v.a,{span:10},s.createElement(R,{label:"值",labelCol:t,wrapperCol:a},s.createElement(p.a,{value:i.value,onChange:this.multiValueChange.bind(this,e.keyName,l,"value"),suffix:r&&n}))),s.createElement(v.a,{span:4},s.createElement(b.a.Group,null,s.createElement(b.a,{icon:"plus",onClick:this.addMultiValue.bind(this,e.keyName)}),1!==e.value.length&&s.createElement(b.a,{icon:"minus",onClick:this.deleteMultiValue.bind(this,e.keyName,l)}))))})}else{if("key-value"===e.type)return!1===Array.isArray(e.value)&&(e.value=[]),(i=e.value.map((t,a)=>{const i=(i,l)=>{let n;if("select"===i.type){let r;Array.isArray(i.options)?r=i.options:"string"==typeof i.options&&(r=this.state[i.options]);const o=r.map(e=>s.createElement(V,{key:e.value,value:e.value},e.name));n=s.createElement(m.a,{value:t[l],placeholder:i.placeholder,onChange:this.multiValueChange.bind(this,e.keyName,a,l)},o)}else n=s.createElement(p.a,{value:t[l],placeholder:i.placeholder,onChange:this.multiValueChange.bind(this,e.keyName,a,l)});return n};return s.createElement("div",{className:"item",key:a},i(e.keyConfig,"key"),s.createElement(f.a,{type:"right"}),i(e.valueConfig,"value"),s.createElement(b.a,{icon:"close",onClick:this.deleteMultiValue.bind(this,e.keyName,a)}))})).unshift(s.createElement(E.a,{key:"divider"},e.label)),i.push(s.createElement("div",{className:"item",key:"plus"},s.createElement(b.a,{icon:"plus",className:"block",onClick:this.addMultiValue.bind(this,e.keyName)}))),i;if("select"===e.type){void 0===e.value&&(e.value=null);const t=s.createElement(V,{key:"all",value:null},e.emptyName||"无"),a=e.options.map(e=>s.createElement(V,{key:e.value,value:e.value},e.name));a.unshift(t);const l={};l.value=e.value,l.onChange="signSchema.id"===e.keyName?this.switchSignSchema.bind(this):this.changeValue.bind(this,e.keyName),i=s.createElement(m.a,Object.assign({},l),a)}else i=s.createElement(p.a,Object.assign({},t))}return a.label=e.label,e.noGrid||(a.labelCol={span:4},a.wrapperCol={span:18}),a.key=e.label,e.required&&(a.required=!0),s.createElement(R,Object.assign({},a),i)}deleteMapItem(e){const{resultModel:t,resultModelList:a}=this.getResultModelAndList();t.mappingValues.find(e=>e.keyName===this.state.editingMapKeyName).mappingMap.splice(e,1),this.setState({resultModelList:a})}render(){const{current:e}=this.state,t=this.state.fields.filter(e=>"sign"===e.category).map(e=>this.makeFormItem(e)),a=s.createElement("div",{className:"step step-one"},s.createElement(c.a,{layout:"horizontal"},t)),i=this.state.fields.filter(e=>"request"===e.category).map(e=>this.makeFormItem(e)),l=s.createElement("div",{className:"step step-two"},s.createElement(c.a,{layout:"horizontal"},i)),n=this.state.cpSourceMap.map(e=>s.createElement("div",{className:"item",onDragStart:this.dragItem.bind(this,e,"cp-source"),draggable:!0,key:e.key,title:e.value+""},e.key)),r=this.state.proxyMap.map((e,t)=>{const a=s.createElement(m.a,{onChange:this.proxyItemChange.bind(this,t,"valueType"),value:e.valueType},s.createElement(V,{value:null},"默认"),s.createElement(V,{value:1,"data-name":"object"},"对象"),s.createElement(V,{value:2,"data-name":"list"},"列表"));return s.createElement("div",{className:"item",key:t},s.createElement("div",{className:"source"},s.createElement(p.a,{value:e.rule,placeholder:"来源表达式",onDrop:this.proxyItemDrop.bind(this,t),onDragOver:this.preventDragOver,onChange:this.proxyItemChange.bind(this,t,"rule")})),s.createElement("div",{className:"icon swap-right-icon"},s.createElement(f.a,{type:"right"})),s.createElement(w,{className:"target",compact:!0},a,s.createElement(p.a,{value:e.name,placeholder:"参数名称",onChange:this.proxyItemChange.bind(this,t,"name")})),s.createElement(b.a,{icon:"close",type:"danger",onClick:this.deleteProxyItem.bind(this,t)}))}),o=this.state.resultModelList.find(e=>e.id===this.state.modelId)||{},d=(o.model||[]).map(e=>({value:e.name,text:e.desc})),h=o.mappings||[],y=h.map((e,t)=>{const a=s.createElement(k.a,{value:e.keyName||void 0,showSearch:!0,dataSource:d,placeholder:"目标参数",style:{minWidth:165},onChange:this.resultItemChange.bind(this,t,"keyName")});return s.createElement("div",{className:"item",key:t},a,s.createElement(f.a,{type:"right"}),s.createElement(p.a,{value:e.valNames,placeholder:"来源数据",onChange:this.resultItemChange.bind(this,t,"valNames")}),s.createElement(S.a,{title:"数据映射"},s.createElement(b.a,{icon:"swap",onClick:this.toggleMapEditor.bind(this,e.keyName)})),s.createElement(S.a,{title:"表达式"},s.createElement(b.a,{icon:"code-o",onClick:this.toggleResultExpressionModal.bind(this,t)})),s.createElement(S.a,{title:"删除"},s.createElement(b.a,{onClick:this.resultItemDelete.bind(this,t),type:"danger",icon:"close"})))}),v=o&&o.fixedValueMap&&o.fixedValueMap.map((e,t)=>s.createElement("div",{className:"item",key:t},s.createElement(p.a,{value:e.key,onChange:this.changeFixedValueMap.bind(this,t,"key"),placeholder:"参数名"}),s.createElement(f.a,{type:"right"}),s.createElement(p.a,{value:e.value,placeholder:"值",onChange:this.changeFixedValueMap.bind(this,t,"value")}),s.createElement(S.a,{title:"删除"},s.createElement(b.a,{onClick:this.deleteFixedValueMap.bind(this,t),type:"danger",icon:"close"})))),N=this.state.fields.filter(e=>"error-handle"===e.category).map(e=>this.makeFormItem(e)),x=s.createElement("div",{className:"step step-three"},s.createElement("div",{className:"cp-map"},n),s.createElement(f.a,{type:"arrow-right"}),s.createElement("div",{className:"proxy-map"},s.createElement("div",{className:"list"},s.createElement(R,{label:"层级属性",className:"item proxy-param"},s.createElement(p.a,{value:this.state.proxyParam.attributes,onChange:this.proxyParamChange.bind(this,"attributes")})),s.createElement(R,{label:"对应层级",className:"item proxy-param"},s.createElement(p.a,{value:this.state.proxyParam.baseRule,onDragOver:this.preventDragOver,onDrop:this.proxyParamDrop.bind(this,"baseRule"),onChange:this.proxyParamChange.bind(this,"baseRule")})),s.createElement(E.a,null,"错误处理"),N,s.createElement(E.a,null,"参数映射"),r,s.createElement("div",{className:"item"},s.createElement(b.a,{icon:"plus",className:"add-proxy-map-item",onClick:this.addProxyItem})))),s.createElement(f.a,{type:"arrow-right"}),s.createElement("div",{className:"target-map"},s.createElement(R,{label:"目标模型",className:"inline item"},s.createElement(m.a,{value:this.state.modelId,onChange:this.modelIdChange,style:{width:345}},this.state.resultModelList.map(e=>s.createElement(V,{key:e.id,value:e.id},e.desc)))),s.createElement("div",{className:"item"},s.createElement(E.a,null,"固定映射参数")),v,s.createElement("div",{className:"item"},s.createElement(b.a,{icon:"plus",className:"block",onClick:this.addFixedValueMap})),s.createElement("div",{className:"item"},s.createElement(E.a,null,"转换列表")),y,s.createElement("div",{className:"item"},s.createElement(b.a,{icon:"plus",className:"block",onClick:this.resultMapAdd})))),C=(o.mappingValues||[]).find(e=>e.keyName===this.state.editingMapKeyName);let I;if(C){const e=C.mappingMap.map((e,t)=>s.createElement("div",{className:"inline-input",key:t},s.createElement(p.a,{value:e.source,onChange:this.mapItemChange.bind(this,"source",t),placeholder:"来源值"}),s.createElement(f.a,{type:"right"}),s.createElement(p.a,{value:e.target,onChange:this.mapItemChange.bind(this,"target",t),placeholder:"目标值"}),s.createElement(S.a,{title:"删除"},s.createElement(b.a,{type:"danger",icon:"close",onClick:this.deleteMapItem.bind(this,t)})))),t=[{key:1,value:"ORIGINAL",name:"原始值"},{key:2,value:"NULL",name:"空值"},{key:3,value:"DEFAULT",name:"默认值"}].map(e=>s.createElement(V,{key:e.key,value:e.value},e.name));t.unshift(s.createElement(V,{key:null,value:null,disabled:!0},"请选择")),I=s.createElement(c.a,{layout:"horizontal"},s.createElement(R,{label:"键名"},s.createElement(p.a,{value:C.keyName,disabled:!0,placeholder:"keyName"})),s.createElement(R,{label:"默认值"},s.createElement(p.a,{value:C.defaultValue,placeholder:"key",onChange:this.mapItemChange.bind(this,"defaultValue",null)})),s.createElement(R,{label:"参数值"},s.createElement(m.a,{value:C.paramMappingSelectEnum,onChange:this.mapItemChange.bind(this,"paramMappingSelectEnum",null)},t)),s.createElement(R,{label:"数据映射"},e,s.createElement(b.a,{icon:"plus",className:"block",onClick:this.addMappingMap.bind(this)})))}return s.createElement("div",{className:"cp-api-manage"},s.createElement("div",{className:"steps"},s.createElement(u.a,{current:e},s.createElement(L,{title:"签名配置"}),s.createElement(L,{title:"访问配置"}),s.createElement(L,{title:"转换配置"}))),s.createElement("div",{className:"step-content"},s.createElement(M.a,{spinning:!!this.state.loading},0===e&&a,1===e&&l,2===e&&x,s.createElement("div",{className:"panel"},s.createElement(E.a,null),s.createElement(b.a.Group,{className:"step-button"},0!==e&&s.createElement(b.a,{onClick:this.previousStep},"上一步"),1===e&&s.createElement(b.a,{onClick:this.checkGrabApi},"验证访问配置"),2===e&&s.createElement(b.a,{onClick:this.checkResultModel},"验证转换配置"),2!==e&&s.createElement(b.a,{onClick:this.nextStep},"下一步")),s.createElement(E.a,{type:"vertical"}),s.createElement(b.a.Group,null,0===e&&s.createElement(b.a,{onClick:this.upsertSignSchema},"保存签名配置"),1===e&&s.createElement(b.a,{onClick:this.saveGrab},"保存访问配置"),2===e&&s.createElement(b.a,{onClick:this.saveGrabResult},"保存"),s.createElement(b.a,{onClick:this.cancel},"取消"))))),s.createElement(g.a,{visible:this.state.isMapEditorOpen,onCancel:this.toggleMapEditor.bind(this,"_cancel"),onOk:this.toggleMapEditor.bind(this,"_ok"),closable:!1,className:"result-mapping-editor-modal",title:"编辑Map"},I),s.createElement(g.a,{visible:this.state.isResultExpressionOpen,title:"编辑转换表达式",className:"result-express-modal",closable:!0,onCancel:this.toggleResultExpressionModal.bind(this,this.state.resultMapEditingIndex,"cancel"),footer:s.createElement(b.a,{type:"primary",onClick:this.toggleResultExpressionModal.bind(this,null,"save")},"保存")},s.createElement(O,{autosize:{minRows:5},value:null===this.state.resultMapEditingIndex?"":h[this.state.resultMapEditingIndex].expression,onChange:this.resultExpressChange,placeholder:"请输入转换表达式"})),s.createElement(g.a,{visible:this.state.isJsonEditorOpen,closable:!1,maskClosable:!1,onOk:this.saveJson,onCancel:this.closeJsonEditor,title:"编辑JSON",className:"json-editor-modal"},s.createElement("div",{id:"json-editor"})),s.createElement(g.a,{visible:this.state.isJsonViewerOpen,closable:!0,maskClosable:!1,onCancel:this.closeJsonViewer,width:720,title:"查看JSON",footer:s.createElement(b.a,{onClick:this.closeJsonViewer},"关闭"),className:"json-viewer-modal"},s.createElement("div",{id:"json-viewer"})))}});t.default=P}}]);
//# sourceMappingURL=31.bundle.js.map