(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{"./assets/component/Modal/EditFormModal.tsx":function(e,t,i){"use strict";i.r(t);var n=i("./node_modules/react/index.js"),s=i("./node_modules/react-redux/es/index.js"),o=i("./assets/lib/ajax.ts"),a=i("./assets/lib/handy.ts"),r=i("./assets/const/API.ts"),l=i("./node_modules/antd/es/form/index.js"),d=i("./node_modules/antd/es/select/index.js"),c=i("./node_modules/antd/es/message/index.js"),u=i("./node_modules/antd/es/input/index.js"),p=i("./node_modules/antd/es/date-picker/index.js"),m=i("./node_modules/antd/es/rate/index.js"),h=i("./node_modules/antd/es/button/index.js"),f=i("./node_modules/antd/es/modal/index.js"),y=i("./node_modules/antd/es/icon/index.js"),g=i("./node_modules/antd/es/upload/index.js"),v=function(e,t,i,n){return new(i||(i=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function r(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(a,r)}l((n=n.apply(e,t||[])).next())})};i("./node_modules/shortid/index.js");const b=i("./node_modules/urijs/src/URI.js");var w=Object(s.b)(function(e){let t=e.table;return t.formFields=e.fields,t},function(e){return{setTableValue:(t,i)=>{e({type:"table.setValue",key:t,value:i})},setFieldsValue:(t,i)=>{e({type:"fields.setValue",key:t,value:i})}}})(class extends n.Component{constructor(e){super(e),this.handleChange=(e=>v(this,void 0,void 0,function*(){const t=[],i=this.props.field,n=i.keyName;for(let n=0;n<e.fileList.length;n++){const s=e.fileList[n];if("done"===s.status){if(!s.response)throw c.a.error(`上传文件(${s.name})失败`),new Error("can not upload file.");if(200!==s.response.code)throw c.a.error("文件("+s.name+")保存失败："+s.response.message),new Error("upload file error: "+JSON.stringify(s));if(s.url=s.response.value,i.reInvoke){const e=i.reInvoke,t=new b(e.api);e.argMap.forEach(e=>{let i="";e.value?i=e.value:e.source&&(i=s[e.source]),t.setQuery(e.keyName,i)});const n=new b(r.a.serverRequest.url);n.setQuery("url",t.toString());const a=yield o.a.get(n);if(200!==a.code)return void c.a.error("获取文件地址失败，java服务器返回信息："+a.message);s.url=a.value}}t.push(Object.assign({},s))}yield this.props.setFieldsValue(n,t),this.props.setTableValue("isEdited",!0)})),this.handleCancel=(()=>{this.setState({previewVisible:!1})}),this.handlePreview=(e=>{let t=e.url||e.thumbUrl;e.response&&200===e.response.code&&e.response.value&&(t=e.response.value),this.setState({previewImage:t,previewVisible:!0})}),this.state={previewVisible:!1,loading:!1}}render(){const e=this.props.field,t=e.keyName,i=e.type,s=(this.props.formFields[t]||[]).map(e=>(e.type="image",e));let o;s.length!==(e.quota||1)&&(o="file"===i?n.createElement(h.a,null,n.createElement(y.a,{type:"upload"})," 上传文件"):n.createElement("div",null,n.createElement(y.a,{type:"plus"}),n.createElement("div",{className:"ant-upload-text"},"上传")));let a="text",l=e.accept||"";return["image","images"].includes(i)&&(a="picture-card",l="image/*"),n.createElement("div",{className:"clearfix image-uploader"},n.createElement(g.a,{accept:l,action:r.a.reUploadImage.url,listType:a,fileList:s,multiple:!1,onPreview:this.handlePreview,onChange:this.handleChange},o),n.createElement(f.a,{visible:this.state.previewVisible,footer:null,onCancel:this.handleCancel},"file"===i?this.state.previewImage:n.createElement("img",{style:{width:"100%"},src:this.state.previewImage})))}}),E=i("./assets/action/freshTableList.ts"),j=i("./node_modules/braft-editor/dist/index.js"),k=i.n(j),N=i("./assets/reducer/index.ts"),x=function(e,t,i,n){return new(i||(i=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function r(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(a,r)}l((n=n.apply(e,t||[])).next())})};const S=i("./node_modules/shortid/index.js");u.a.Search;var F=Object(s.b)(function(e){return{formFields:e.fields,tableFields:e.table.fields}})(class extends n.Component{constructor(e){super(e),this.crawl=(()=>x(this,void 0,void 0,function*(){this.setState({isLoading:!0,loadingTime:60});const e=setInterval(()=>{this.state.isLoading&&this.state.loadingTime?this.setState({loadingTime:this.state.loadingTime-1}):this.stopLoading(e)},1e3),t=yield o.a.post(r.a.crawlUrl.url,{url:this.state.url});if(200===t.code){const e=t.value;this.setFieldValue("author",e.author),this.setFieldValue("content",e.content);const i=JSON.parse(JSON.stringify(this.props.tableFields));i.find(e=>"content"===e.keyName)._key=S.generate(),N.default.dispatch({type:"table.setValue",key:"fields",value:i}),this.setFieldValue("title",e.title),this.setFieldValue("contentTitle",e.title),this.setFieldValue("cpSource",e.source),this.setFieldValue("imgUrls",e.imgMap.map(e=>(e.uid=S.generate(),e.name=e.id,e.status="done",e.thumbUrl=e.url,e))),this.setFieldValue("keywords",e.keywords.join(",")),c.a.success("抓取成功")}else c.a.error(t.message);this.setState({isLoading:!1})})),this.onChange=(e=>{this.setState({url:e.target.value})}),this.state={url:"",isLoading:!1,loadingTime:0}}setFieldValue(e,t){N.default.dispatch({type:"fields.setValue",key:e,value:t})}stopLoading(e){clearInterval(e),this.setState({isLoading:!1})}render(){const e={};e.onPressEnter=this.crawl,e.onChange=this.onChange,e.style={marginRight:"8px"};const t={style:{float:"right"}};return t.onClick=this.crawl,t.loading=this.state.isLoading,t.type="primary",n.createElement("div",{style:{display:"flex"}},n.createElement(u.a,Object.assign({},e)),n.createElement(h.a,Object.assign({},t),this.state.isLoading?` ${this.state.loadingTime} `:"抓取"))}}),L=i("./assets/action/buttonActions.ts"),C=i("./assets/action/miscellaneous.ts"),T=function(e,t,i,n){return new(i||(i=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function r(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(a,r)}l((n=n.apply(e,t||[])).next())})};const O=i("./node_modules/b64-to-blob/b64toBlob.js"),V=/^data:(image\/\w{1,5});base64,/,M=/^blob:/,P=function(e){return new Promise(t=>{const i=new XMLHttpRequest;i.onload=(()=>{const e=JSON.parse(i.responseText);t(e)});const n=new FormData;i.open("POST",r.a.reUploadImage.url),n.append("file",e),i.send(n)})};var I=function(e){return T(this,void 0,void 0,function*(){console.log("save img url: ",e);const t=V.test(e),i=M.test(e);if(t)return yield function(e){return new Promise(t=>{const i=e.match(V)[1],n=i.match(/\/(.*)/)[1],s=Date.now()+"."+n,o=O(e.replace(V,""),i),a=new File([o],s,{type:i,lastModified:Date.now()});t(P(a))})}(e);if(i){const t=yield function(e){return new Promise(t=>{const i=new XMLHttpRequest;i.open("GET",e),i.responseType="blob",i.onload=function(){if(200===this.status){const e=i.getResponseHeader("Content-Type"),n=e.match(/\/(.*)/)[1],s=Date.now()+"."+n,o=this.response,a=new File([o],s,{type:e,lastModified:Date.now()});t(a)}},i.send()})}(e);return yield P(t)}return yield o.a.post(r.a.saveImage.url,{imgUrl:e})})},A=i("./assets/action/informServer.ts"),U=function(e,t,i,n){return new(i||(i=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function r(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(a,r)}l((n=n.apply(e,t||[])).next())})};const _=i("./node_modules/urijs/src/URI.js");var R=function(){return U(this,void 0,void 0,function*(){if(!(yield this.validate()))return;const e=this.props.contentEditModal.options.isEditing,t=this.props.fields.find(e=>!0===e.isPrimaryKey),i=t.upsertConfig,n=t.updateConfig,s=t.addConfig,l=this.props.formFields;console.log("submit data: ",l);const d={};let u,p;i||n||s?u=d:(d.fields={},d.dbName=this.props.dbName,d.tableName=this.props.tableName,u=d.fields),this.setState({confirmLoading:!0});for(const t of this.props.fields){const i=t.keyName;let n=l[i];if(t){if(!["create-time","update-time"].includes(t.type)){if(e){if(t.notShowWhenUpdate)continue}else if(t.newByField){const e=this.props.fields.find(e=>e.keyName===t.newByField.keyName);if(!e)throw new Error('can not find "newByField" target field.');if(t.newByField.targetProperty){if("select"!==e.type)throw new Error('if you set "targetProperty", than the target field must be a "select" type.');const i=e.options.find(t=>t.value===l[e.keyName]);i&&(n=i[t.newByField.targetProperty])}}else if(t.notShowWhenNew)continue;if(n||!t.isSentEvenEmpty||"number"==typeof n){if(!t.isAutoGen||n){if(t.isForceSend);else{if(t.uneditable)continue;if(t.isNotSend)continue}if(!(n instanceof File))if("bit"===t.valueType&&Array.isArray(n)&&(n=a.a.transferIndexToBit(n)),"string"==typeof n&&(n=n.trim()),"wysiwyg"===t.type){n=n.toHTML();const e=document.createElement("template");e.innerHTML=n;const t=e.content.querySelectorAll("img");for(const e of t){const t=e.src||e.getAttribute("data-src");if(!t){console.warn("can not find image in content img src.");continue}if(/^file:/.test(t)){c.a.error("由于浏览器的安全保护机制，目前不能直接上传本地文件。");continue}const i=new _(t),n=i.query(!0),s=i.protocol();if(!["blob","data"].includes(s)){if(/(\.mzres\.)|(\.meizu\.)/.test(t)){const t=e.width,i=e.height;if(!t||!i){const t=n.width,i=n.height;t&&e.setAttribute("width",t),i&&e.setAttribute("height",i)}}else{const i=yield o.a.post(r.a.saveImage.url,{imgUrl:t});200===i.code&&e.setAttribute("src",i.value)}continue}const a=yield I(t);if(200===a.code)if(a.value){console.log("replace src: "+a.value);const t=new _(a.value).query(!0),i=t.width,n=t.height;e.setAttribute("width",i),e.setAttribute("height",n),e.setAttribute("src",a.value)}else console.error("server response img without value, please check what happened.")}const s=e.innerHTML;console.log("html: ",s),u[i]=s}else if(["image","images","file"].includes(t.type)){if(!n)continue;!1===Array.isArray(n)&&(n=[n]);const e=[];for(const t of n){if(!t)throw new Error("找不到上传的文件");e.push(t.url)}a.a.isValuePath(t.keyName)?a.a.applyObjByPath(u,t.keyName,e.join(",")):u[i]=e.join(",")}else"string"!=typeof n&&"number"!=typeof n||(a.a.isValuePath(t.keyName)?a.a.applyObjByPath(u,t.keyName,n):u[i]=n)}}else u[i]=""}}else console.log("can not find this field: "+i)}let m,h=r.a.updateTableRow.url,f="json",y=!1;if((m=e?n||i:s)&&(h=m.api,y=m.isRedirect||y,f=m.enctype||f),y){const e=new _(r.a.serverRequest.url);e.setQuery("url",h),h=e.toString()}try{p=yield function(e){return console.log("invoke args: ",e),new Promise((t,i)=>{const n=new XMLHttpRequest;n.open(e.method,e.url);const s=e.headers||{};s["X-Requested-With"]="XMLHttpRequest";const o=e.enctype||"json";let a;/urlencoded/i.test(o)?(s["content-type"]="application/x-www-form-urlencoded; charset=UTF-8",e.payload&&(a=Object.entries(e.payload).map(([e,t])=>([void 0,null].includes(t)&&(t=""),Array.isArray(t)?t.map(t=>`${e}=${encodeURIComponent(t+"")}`).join("&"):("string"==typeof t&&(t=t.trim()),`${e}=${encodeURIComponent(t+"")}`))).join("&"))):(s["content-type"]="application/json; charset=UTF-8",e.payload&&(a=JSON.stringify(e.payload))),Object.entries(s).forEach(([e,t])=>{n.setRequestHeader(e,t+"")}),n.onload=(()=>{const e=JSON.parse(n.responseText);t(e)}),n.onerror=(e=>{i(e)}),n.send(a)})}({url:h,method:"POST",payload:d,enctype:f})}catch(e){console.error(e),c.a.error("保存失败，服务器发生错误")}this.setState({confirmLoading:!1}),p&&(200===p.code?(c.a.success("保存成功"),this.toggleModal(),this.freshList(),A.a.call(this)):c.a.error("保存失败："+p.message))})},B=function(e,t,i,n){return new(i||(i=Promise))(function(s,o){function a(e){try{l(n.next(e))}catch(e){o(e)}}function r(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(a,r)}l((n=n.apply(e,t||[])).next())})};const q=i("./node_modules/shortid/index.js"),H=(i("./node_modules/urijs/src/URI.js"),i("./node_modules/moment/moment.js")),J=i("./common/SYSTEM.js"),W=i("./assets/img/default.jpg"),D=(i("./common/URL.js"),J.urlVersion.value,"YYYY-MM-DD HH:mm:ss"),Y=l.a.Item,$=d.a.Option;const z=Object(s.b)(function(e){let t=Object.assign({},e.table);return t.contentEditModal=e.modal.contentEditModal,t.formFields=e.fields,t},function(e){return{setTableValue:(t,i)=>{e({type:"table.setValue",key:t,value:i})},setFieldsValue:(t,i)=>{e({type:"fields.setValue",key:t,value:i})},dispatch:e}})(class extends n.Component{constructor(e){super(e),this.freshList=this.props.freshList||E.a.bind(this),this.state={confirmLoading:!1}}toggleModal(){this.state.confirmLoading?c.a.info("正在上传数据，请稍候..."):this.props.dispatch({type:"modal.toggle",modalName:"contentEditModal"})}fieldChange(e,t){return B(this,void 0,void 0,function*(){this.props.isEdited||this.props.dispatch({type:"table.setValue",value:{isEdited:!0}});let i=t;const n=e.keyName;if(n){t&&t.target&&void 0!==t.target.value&&(i=t.target.value),"wysiwyg"===e.type?this.props.setFieldsValue(n,i):i instanceof H?i=i.format(D):i&&i.fileList&&((i={}).fileList=t.fileList.map(e=>{const t={};return t.name=e.name,t.uid=q.generate(),t.status=e.status,t.percent=e.percent,t.type=e.type,t.size=e.size,e.response&&(t.url=e.response.value),t}));for(const e of this.props.fields)if(e.optionFilter&&e.optionFilter===n){this.props.setFieldsValue(e.keyName,void 0);break}this.props.setFieldsValue(n,i)}})}validate(){return B(this,void 0,void 0,function*(){const e=this.props.fields.find(e=>!0===e.isPrimaryKey),t=this.props.formFields[e.keyName];for(const i of this.props.fields){let n=this.props.formFields[i.keyName];const s=typeof n;if(!i.uneditable){if(i.isRequired){if(["",[],null,void 0].includes(n))return c.a.error(i.name+" 不能为空"),!1;if(["file","image","images"].includes(i.type)&&(!n||0===n.length))return console.log("upload files: ",n),c.a.error(i.name+" 至少要上传一个文件"),!1}if("number"===i.valueType&&!1===a.a.isEmpty(n)){if(n=+n,isNaN(n))return c.a.error(i.name+" 为数字类型"),!1}else"string"===s&&(n=n.trim());if(i.isUnique){const s=i.keyName,a=n,l=yield o.a.get(r.a.getByKeyName.url,{dbName:this.props.dbName,tableName:this.props.tableName,keyName:s,keyValue:a});if(l.value&&l.value.length){const n=l.value.filter(i=>i[e.keyName]!==t);if(n.length)return c.a.error(i.name+" 必须唯一"),!1;console.log(n)}}}}return!0})}submit(){return B(this,void 0,void 0,function*(){const e=this.props.fields.find(e=>e.isPrimaryKey);if(e.beforeSubmit){const t=C.a.find(t=>t.name===e.beforeSubmit);t&&(yield t.action.call(this))}R.call(this)})}render(){const e=this.props.fields,t=e.find(e=>e.isPrimaryKey),i=this.props.contentEditModal.options.isEditing,s=this.props.formFields;let o=e.filter(e=>{if(["update-time","create-time","dropdown-button","button"].includes(e.type))return!1;if(i){if(e.notShowWhenUpdate)return!1}else if(e.notShowWhenNew)return!1;if(!0===e.uneditable)return!1;if(i){if(e.hideWhenEdit)return!1}else if(e.isAutoGen)return!1;if(e.isShow){if("boolean"==typeof e.isShow)return e.isShow;const t=this.props.formFields[e.isShow.keyName];return e.isShow.value===t||"empty"===e.isShow.value&&!t}return!0});const r=(o=o.sort((e,t)=>void 0===t.formOrder?-1:void 0===e.formOrder?1:e.formOrder-t.formOrder)).map((e,t)=>{const o={},r=(e=JSON.parse(JSON.stringify(e))).keyName;let l,c=s[r],f={};if((e.readonly||i&&e.readonlyWhenEdit)&&(f.disabled=!0),e.placeholder&&(f.placeholder=e.placeholder),"textarea"===e.type){const{TextArea:t}=u.a;l=n.createElement(t,Object.assign({},f,{row:4,value:c,onChange:this.fieldChange.bind(this,e)}))}else if("select"===e.type){if(e.optionFilter){const t=e.optionFilter,i=s[t];e.options=void 0===i?[]:e.options.filter(e=>e.row[t]===i)}"bit"===e.valueType&&!1===Array.isArray(c)&&(c=a.a.transferIntToBitIndex(c)),"multiple"===e.mode?f.mode="multiple":e.options.find(e=>e.value===c)||(c=void 0);let t=e.options.filter(t=>!("multiple"!==e.mode||!c.includes(t.value))||t.value===c||!t.hideWhenEdit).map(e=>n.createElement($,{key:e.value,value:e.value},e.name));!f.placeholder&&(f.placeholder="请选择"),l=n.createElement(d.a,Object.assign({},f,{onChange:this.fieldChange.bind(this,e),value:c}),t)}else if(["image","images","file"].includes(e.type))if(!0===e.readonly){const e={style:{width:100,height:100}};Array.isArray(c)&&c.length?e.src=c[0].url:e.src=W,l=n.createElement("img",Object.assign({},e))}else l=n.createElement(w,{field:e,value:c});else if("wysiwyg"===e.type){const t={onChange:this.fieldChange.bind(this,e),height:300,value:c,media:{allowPasteImage:!0,image:!0}};l=n.createElement(k.a,Object.assign({},t,f))}else if("field-button"===e.type){if("CrawlInput"!==e.inputName)throw new Error("Have not implement this input type: "+e.type);l=n.createElement(F,null)}else if("date"===e.type){c&&(c="unix-time"===e.timeType?new H(c):new H(c,D));const t={showTime:!0};t.format=D,t.placeholder="点击选择时间",t.onChange=this.fieldChange.bind(this,e),t.style={width:280},t.value=c,!0===e.readonly&&(t.disabled=!0),l=n.createElement(p.a,Object.assign({},t))}else if("rate"===e.type){const t={};e.allowHalf&&(t.allowHalf=!0),t.value=c,t.onChange=this.fieldChange.bind(this,e),l=n.createElement(m.a,Object.assign({},t))}else l=n.createElement(u.a,Object.assign({onChange:this.fieldChange.bind(this,e)},f,{value:c}));o.label=e.name,o.key=e._key||r;let y="";return Array.isArray(e.buttons)&&(y=e.buttons.map(t=>{const i={key:t.actionName},s=L.a.find(e=>e.name===t.actionName);s&&(i.onClick=s.action.bind(this,e)),t.isLoading&&(i.loading=!0,i.disabled=!0);const o=t.tempName||t.name;return o?n.createElement(h.a,Object.assign({},i),o):(i.icon=t.icon,n.createElement(h.a,Object.assign({},i)))})),n.createElement(Y,Object.assign({},o),l,y)}),c=this.props.contentEditModal,y=this.props.editModalWidth||720;let g=[{name:"保存",action:this.submit.bind(this,i),isLoading:this.state.confirmLoading,order:1,disabledIfNotEdited:!0},{name:"取消",action:this.toggleModal.bind(this),order:2}];t&&t.extraEditButtons&&(g=g.concat(t.extraEditButtons)),g.sort((e,t)=>(void 0===e.order&&(e.order=0),void 0===t.order&&(t.order=0),e.order-t.order));const v=g.map(e=>{const t={};if(e.action)t.onClick=e.action;else{const i=L.a.find(t=>t.name===e.actionName);t.onClick=i.action.bind(this)}return e.isLoading&&(t.loading=!0),t.key=e.name,e.disabledIfNotEdited&&(t.disabled=!this.props.isEdited),n.createElement(h.a,Object.assign({},t),e.name)});return n.createElement(f.a,{title:c&&c.options&&c.options.modalTitle||"-",className:"edit-form-modal",width:y,visible:c&&c.isOpen,maskClosable:!1,footer:v,onCancel:this.toggleModal.bind(this),confirmLoading:this.state.confirmLoading},n.createElement(l.a,{layout:"vertical"},r))}});t.default=z},"./common/URL.js":function(e,t,i){const n=i("./common/SYSTEM.js");e.exports={userLogin:{name:"用户登录",value:"https://login.flyme.cn/login/login.html"},userLogout:{name:"用户退出登录",value:"https://login.flyme.cn/sso/logout"},getUserInfo:{name:"获取用户信息（加密接口）",value:"https://i.flyme.cn/uc/sign/getLoginInfoByTicket"},refreshUserToken:{name:"刷新用户token时间",value:"https://i.flyme.cn/uc/webservice/refreshTokenByTicket"},imageUpload:{name:"图片上传，要带上cookie，需要登录认证",value:"http://om.iflow.meizu.com/service/common/upload"},redirectCpContent:{name:"通过id参数，自动跳转到cp内容页",value:"/"+n.urlVersion.value+"/api/contents/redirect-cp-content"}}}}]);
//# sourceMappingURL=35.bundle.js.map